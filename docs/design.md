# レシピ本写真解析・レシピ内容取得システム (Firebase Functions版) 設計情報

---

## 1. システム概要

* **目的:** レシピ本の写真をアップロードまたは指定することで、レシピのタイトル、材料、作り方などの情報を抽出・構造化するとともに、完成した料理や調理中の写真も検出・抽出する。
* **主要機能:**
    * 写真のアップロード/URL入力機能
    * **画像オブジェクト検出:** Cloud Vision APIのObject Detection機能を利用し、写真に写っている料理や調理器具などのオブジェクトを検出します。
    * Cloud Vision APIによるOCR処理（テキスト抽出）
    * Gemini APIによるレシピテキストの解析と情報抽出
    * 抽出されたレシピ情報の構造化と表示
    * **検出された料理/調理写真の抽出と表示**
* **アーキテクチャ:** Firebase Functionsとして構築し、Firebase Hostingや他のFirebaseサービスと連携することを想定。

---

## 2. データフロー

1.  **入力:** ユーザーはレシピ本の写真（画像ファイルまたはURL）をシステムに提供します。
2.  **画像オブジェクト検出:**
    * Firebase Functionが、入力された画像データまたはURLを受け取ります。
    * Cloud Vision APIのObject Detection機能を呼び出し、画像内のオブジェクト（料理、食材、調理器具など）とその位置情報を検出します。
    * 検出結果から、特定のラベル（例: "Food", "Dish", "Cookware" など）を持つオブジェクトを料理や調理関連の写真として特定します。
    * 検出されたオブジェクトのバウンディングボックス情報（位置とサイズ）を保存します。
3.  **OCR処理:**
    * Firebase Functionが、入力された画像データまたはURLを受け取ります。
    * Cloud Vision APIのDocument Text Detection機能を呼び出し、画像からテキストを抽出します。
    * 抽出されたテキストは、次のステップに渡されます。
4.  **レシピ解析:**
    * Firebase Functionが、OCRで抽出されたテキストを受け取ります。
    * Gemini APIを呼び出し、レシピテキストの解析と情報抽出を指示するプロンプトを送信します。
    * Gemini APIからの応答（抽出されたレシピ情報を含むテキスト）を受け取ります。
5.  **データ構造化:**
    * Firebase Functionが、Gemini APIからの応答と画像オブジェクト検出の結果を統合し、レシピ情報を構造化された形式（例：JSONオブジェクト）に変換します。
    * 構造化されたデータには、タイトル、材料（材料名と分量）、作り方（手順のリスト）、**検出された料理/調理写真の情報（バウンディングボックスなど）**が含まれます。
6.  **出力:** 構造化されたレシピ情報と、検出された料理/調理写真の情報（バウンディングボックスなど）をユーザーに返します。必要に応じて、検出された画像をプレビュー表示する処理をクライアント側で実装します。

---

## 3. Firebase Functions 設計

* **関数名:** `processRecipeImage`
* **トリガー:**
    * HTTPトリガー (`functions.https.onRequest`) - 画像URLをリクエストボディで受け取る想定。
    * （オプション）Cloud Storageトリガー (`functions.storage.object().onFinalize`) - Firebase Storageに画像がアップロードされた際に実行。
* **処理内容:**
    1.  リクエストから画像URLまたはStorage上のパスを取得します。
    2.  Cloud Vision APIクライアントを初期化します。
    3.  **画像オブジェクト検出:** Cloud Vision APIの `objectLocalization` メソッドを呼び出し、料理や調理関連のオブジェクトを検出します。
    4.  **OCR処理:** Cloud Vision APIの `documentTextDetection` メソッドを呼び出し、テキストを抽出します。
    5.  Gemini APIクライアントを初期化します。
    6.  抽出されたテキストをGemini APIに送信し、レシピ情報を抽出するプロンプトを実行します。
    7.  Gemini APIからの応答を解析し、レシピ情報を構造化します（JSON形式など）。
    8.  検出された料理/調理写真の情報と構造化されたレシピ情報を統合します。
    9.  結果をHTTPレスポンスとして返します。

---

## 4. プロンプト設計 (Gemini API)

Gemini APIに送信するプロンプトは、レシピ情報の抽出精度を大きく左右します。

```
与えられたレシピテキストから、以下の情報を抽出してJSON形式で返してください。

- タイトル
- 材料（材料名と分量をセットで）
- 作り方（手順を箇条書きで）

レシピテキスト:
\`\`\`
[OCRで抽出されたテキスト]
\`\`\`

* レシピのフォーマット多様性への対応を考慮します。
* 曖昧な表現の解釈ルールを必要に応じて指示します。
* 追加情報の抽出（カロリー、アレルギーなど）も検討可能です。

```

## 5. エラーハンドリング

* Cloud Vision API、Gemini APIの呼び出し時のエラーを `try-catch` ブロックで捕捉し、適切なエラーレスポンスをクライアントに返します。
* 画像形式の不正、APIキーの無効、ネットワークエラーなど、考えられるエラーケースに対応します。
* Gemini APIがレシピ情報を抽出できなかった場合の処理を実装します。

---

## 6. デプロイメント

* Firebase CLIを使用して、Firebase Functionsをデプロイします (`firebase deploy --only functions`).
* Cloud Vision APIとGemini APIの認証設定をFirebaseプロジェクトで行います。

---

## 7. ユーザーインターフェース (オプション)

* Webアプリケーション (Firebase Hosting) やモバイルアプリケーションから、HTTPリクエストをFirebase Functionに送信し、画像URLまたはアップロードされた画像データを渡します。
* レスポンスとして受け取ったレシピ情報と写真情報を表示します。検出された写真にはバウンディングボックスを重ねて表示するなどの工夫が考えられます。

---

## 8. 今後の拡張

* 検出された料理の種類を詳細に分類する。
* 調理中の写真から調理工程を推測する。
* 検出された料理写真と抽出されたレシピ情報を紐付ける。
* Firestoreへのレシピ情報や画像メタデータの保存。
* ユーザー認証機能の追加。

---

このMarkdownファイルは、Firebase Functionsを使ってレシピ本の写真解析・レシピ内容取得システムを構築するための基本的な設計情報を提供します。具体的な実装では、各項目の詳細をさらに検討する必要があります。